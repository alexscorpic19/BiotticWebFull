#=========================================================================#
# Configuraci칩n Optimizada y Corregida para BiotticWeb (HTTPS)          #
#=========================================================================#

server {
    listen      92.112.177.130:443 ssl http2;
    server_name biottic.com.co www.biottic.com.co;
    error_log   /var/log/apache2/domains/biottic.com.co.error.log error;

    # Ocultar versi칩n de Nginx
    server_tokens off;

    # --- Certificados SSL y Hestia (sin cambios) ---
    ssl_certificate     /home/admin/conf/web/biottic.com.co/ssl/biottic.com.co.pem;
    ssl_certificate_key /home/admin/conf/web/biottic.com.co/ssl/biottic.com.co.key;
    ssl_stapling        on;
    ssl_stapling_verify on;
    include /home/admin/conf/web/biottic.com.co/nginx.hsts.conf*;

    # --- Cabeceras de Seguridad y Rendimiento (Gzip) ---
    add_header X-Frame-Options 'SAMEORIGIN' always;
    add_header X-Content-Type-Options 'nosniff' always;
    add_header Referrer-Policy 'strict-origin-when-cross-origin' always;
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    location ~ /\.(?!well-known\/|file) {
        deny all;
        return 404;
    }

    # --- REGLAS DE PROXY CORREGIDAS ---

    # Peticiones a la API -> van al BACKEND (puerto 5001)
    location /api/ {
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Peticiones de im치genes cargadas -> van al BACKEND (puerto 5001)
    location /uploads/ {
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # El resto del tr치fico (la app de React) -> va al FRONTEND (puerto 8082)
    location / {
        proxy_pass http://127.0.0.1:8082;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Bloques de Hestia (sin cambios) ---
    location /error/ {
        alias /home/admin/web/biottic.com.co/document_errors/;
    }
    proxy_hide_header Upgrade;
    include /home/admin/conf/web/biottic.com.co/nginx.ssl.conf_*;
}